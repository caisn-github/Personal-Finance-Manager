<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>个人财务报表软件</title>
<!-- TailwindCSS -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/0915/3.4.17.js"></script>
<!-- Font Awesome -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/js/all.min.js"></script>
<link href="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/css/fontawesome.min.css" rel="stylesheet"/>
<!-- ECharts -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/cdn-staticfile-net/echarts/5.4.3/echarts.min.js"></script>
<style>
        /* Custom styles for transitions and specific UI tweaks */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }
        .toast {
            background: white;
            border-left: 4px solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        .toast-success { border-color: #10B981; }
        .toast-info { border-color: #3B82F6; }
        .toast-error { border-color: #EF4444; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Input styling overrides */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">
<!-- Toast Container -->
<div id="toast-container"></div>
<!-- Header -->
<header class="bg-indigo-600 text-white shadow-lg sticky top-0 z-40">
<div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
<div class="flex items-center gap-3">
<i class="fa-solid fa-chart-line text-2xl"></i>
<h1 class="text-xl font-bold tracking-wide">个人财务报表</h1>
</div>
<div class="flex items-center gap-4 bg-indigo-700 px-4 py-2 rounded-lg">
<label class="text-sm font-medium whitespace-nowrap" for="month-picker">选择月份:</label>
<input class="bg-indigo-600 border border-indigo-500 text-white rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-300" id="month-picker" type="month"/>
</div>
<div class="flex items-center gap-2">
<button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow transition flex items-center gap-2 text-sm" id="btn-save">
<i class="fa-solid fa-save"></i> <span class="hidden sm:inline">保存</span>
</button>
<button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded shadow transition flex items-center gap-2 text-sm" id="btn-reset">
<i class="fa-solid fa-rotate-left"></i> <span class="hidden sm:inline">重置</span>
</button>
<div class="relative group">
<button class="bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded shadow transition flex items-center gap-2 text-sm" id="btn-data">
<i class="fa-solid fa-database"></i> <span class="hidden sm:inline">数据</span>
<i class="fa-solid fa-caret-down"></i>
</button>
<!-- Dropdown -->
<div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block hover:block ring-1 ring-black ring-opacity-5 z-50">
<button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="btn-export">
<i class="fa-solid fa-file-export mr-2"></i>导出数据
                        </button>
<button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="btn-import-trigger">
<i class="fa-solid fa-file-import mr-2"></i>导入数据
                        </button>
<input accept=".json" class="hidden" id="file-import" type="file"/>
</div>
</div>
</div>
</div>
</header>
<!-- Main Content -->
<main class="container mx-auto px-4 py-6 flex-grow">
<!-- Summary Cards -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
<!-- Net Worth Card -->
<div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-indigo-500 hover:shadow-lg transition">
<div class="flex justify-between items-start">
<div>
<p class="text-sm font-medium text-gray-500">当月净资产</p>
<h3 class="text-2xl font-bold text-gray-800 mt-1" id="summary-net-worth">¥0.00</h3>
</div>
<div class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
<i class="fa-solid fa-wallet text-xl"></i>
</div>
</div>
<p class="text-xs text-gray-400 mt-2">总资产 - 总负债</p>
</div>
<!-- Total Income Card -->
<div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition">
<div class="flex justify-between items-start">
<div>
<p class="text-sm font-medium text-gray-500">当月总收入</p>
<h3 class="text-2xl font-bold text-gray-800 mt-1" id="summary-total-income">¥0.00</h3>
</div>
<div class="p-2 bg-green-100 rounded-lg text-green-600">
<i class="fa-solid fa-sack-dollar text-xl"></i>
</div>
</div>
<p class="text-xs text-gray-400 mt-2">工资 + 其他 + 投资收益</p>
</div>
<!-- Total Expense Card -->
<div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500 hover:shadow-lg transition">
<div class="flex justify-between items-start">
<div>
<p class="text-sm font-medium text-gray-500">当月总支出</p>
<h3 class="text-2xl font-bold text-gray-800 mt-1" id="summary-total-expense">¥0.00</h3>
</div>
<div class="p-2 bg-red-100 rounded-lg text-red-600">
<i class="fa-solid fa-credit-card text-xl"></i>
</div>
</div>
<p class="text-xs text-gray-400 mt-2">基于净资产变动计算</p>
</div>
</section>
<!-- Tabs Navigation -->
<nav class="flex border-b border-gray-200 mb-6 overflow-x-auto">
<button class="tab-btn active px-6 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 focus:outline-none transition whitespace-nowrap" data-target="tab-balance">
<i class="fa-solid fa-scale-balanced mr-2"></i>资产负债表
            </button>
<button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent focus:outline-none transition whitespace-nowrap" data-target="tab-income">
<i class="fa-solid fa-file-invoice-dollar mr-2"></i>损益表
            </button>
<button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent focus:outline-none transition whitespace-nowrap" data-target="tab-stats">
<i class="fa-solid fa-chart-pie mr-2"></i>其他统计数据
            </button>
<button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent focus:outline-none transition whitespace-nowrap" data-target="tab-charts">
<i class="fa-solid fa-chart-area mr-2"></i>图表分析
            </button>
</nav>
<!-- Tab Contents -->
<div class="tab-content fade-in">
<!-- Tab 1: Balance Sheet -->
<section class="tab-panel" id="tab-balance">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Assets -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-coins text-indigo-500 mr-2"></i> 资产
                        </h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">现金</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="cash" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">银行存款/余额</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="bank" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">股权投资</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="equity" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">房地产</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="realEstate" placeholder="0" type="number"/>
</div>
</div>
<div class="pt-4 border-t border-gray-100 flex justify-between items-center bg-indigo-50 p-3 rounded">
<span class="font-bold text-gray-700">总资产</span>
<span class="font-bold text-indigo-700 text-lg" id="display-total-assets">¥0.00</span>
</div>
</div>
</div>
<!-- Liabilities & Net Worth -->
<div class="space-y-6">
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-hand-holding-dollar text-red-500 mr-2"></i> 负债
                            </h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">信用卡/短期贷款</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="creditCard" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">银行贷款</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="bankLoan" placeholder="0" type="number"/>
</div>
</div>
<div class="pt-4 border-t border-gray-100 flex justify-between items-center bg-red-50 p-3 rounded">
<span class="font-bold text-gray-700">总负债</span>
<span class="font-bold text-red-700 text-lg" id="display-total-liabilities">¥0.00</span>
</div>
</div>
</div>
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-md p-6 text-white">
<div class="flex justify-between items-center">
<div>
<p class="text-indigo-100 text-sm">净资产</p>
<p class="text-xs text-indigo-200 opacity-80">总资产 - 总负债</p>
</div>
<span class="font-bold text-2xl" id="display-net-worth">¥0.00</span>
</div>
</div>
</div>
</div>
</section>
<!-- Tab 2: Income Statement -->
<section class="tab-panel hidden" id="tab-income">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Income -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-arrow-trend-up text-green-500 mr-2"></i> 收入
                        </h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">工资</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="salary" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">其他收入</label>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="otherIncome" placeholder="0" type="number"/>
</div>
</div>
<div class="bg-gray-50 p-3 rounded border border-gray-200">
<div class="flex justify-between items-center">
<div>
<label class="block text-sm font-medium text-gray-700">投资收入</label>
<p class="text-xs text-gray-500">自动计算：当月股权 - 上月股权 - 新增</p>
</div>
<span class="font-bold text-gray-800" id="display-inv-income">¥0.00</span>
</div>
</div>
<div class="pt-4 border-t border-gray-100 flex justify-between items-center bg-green-50 p-3 rounded">
<span class="font-bold text-gray-700">总收入</span>
<span class="font-bold text-green-700 text-lg" id="display-total-income">¥0.00</span>
</div>
</div>
</div>
<!-- Expense & Formula -->
<div class="space-y-6">
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-arrow-trend-down text-red-500 mr-2"></i> 支出
                            </h3>
<div class="bg-red-50 p-4 rounded-lg border border-red-100 mb-4">
<div class="flex justify-between items-center">
<span class="font-bold text-gray-700">总支出</span>
<span class="font-bold text-red-700 text-lg" id="display-total-expense">¥0.00</span>
</div>
</div>
<div class="mt-6">
<h4 class="text-sm font-bold text-gray-700 mb-2">计算公式说明</h4>
<div class="bg-gray-100 p-3 rounded text-sm text-gray-600 font-mono mb-2">
                                    总支出 = 上月净资产 + 当月总收入 - 当月净资产
                                </div>
<div class="space-y-2 text-sm">
<div class="flex justify-between">
<span class="text-gray-500">上月净资产:</span>
<span class="font-medium" id="calc-last-nw">¥0.00</span>
</div>
<div class="flex justify-between">
<span class="text-gray-500">当月总收入:</span>
<span class="font-medium" id="calc-cur-income">¥0.00</span>
</div>
<div class="flex justify-between border-t pt-2 mt-2">
<span class="text-gray-500">当月净资产:</span>
<span class="font-medium" id="calc-cur-nw">¥0.00</span>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<!-- Tab 3: Other Statistics -->
<section class="tab-panel hidden" id="tab-stats">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Investment Analysis -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-chart-line text-indigo-500 mr-2"></i> 投资分析
                        </h3>
<div class="space-y-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">新增投资</label>
<p class="text-xs text-gray-500 mb-2">本月新投入的资金</p>
<div class="relative rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm">¥</span>
</div>
<input class="block w-full rounded-md border-gray-300 pl-7 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border" name="newInvestment" placeholder="0" type="number"/>
</div>
</div>
<div class="bg-indigo-50 p-4 rounded border border-indigo-100">
<div class="flex justify-between items-center">
<div>
<label class="block text-sm font-medium text-indigo-800">投资收入 (计算)</label>
<p class="text-xs text-indigo-600">公式: 当月股权 - 上月股权 - 新增</p>
</div>
<span class="font-bold text-indigo-800 text-xl" id="stats-inv-income">¥0.00</span>
</div>
</div>
</div>
</div>
<!-- Key Metrics -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
<i class="fa-solid fa-calculator text-purple-500 mr-2"></i> 关键指标
                        </h3>
<div class="space-y-6">
<div>
<div class="flex justify-between items-end mb-2">
<label class="block text-sm font-medium text-gray-700">ROE (净资产收益率)</label>
<span class="text-2xl font-bold text-purple-600" id="stats-roe">0%</span>
</div>
<p class="text-xs text-gray-500">公式: (工资 × 12) ÷ 净资产</p>
</div>
<div>
<div class="flex justify-between items-end mb-2">
<label class="block text-sm font-medium text-gray-700">储蓄率 (估算)</label>
<span class="text-lg font-bold text-gray-700" id="stats-savings-rate-text">0%</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200">
<div class="bg-green-500 h-2.5 rounded-full" id="stats-savings-bar" style="width: 0%"></div>
</div>
<p class="text-xs text-gray-500 mt-1">估算公式: (总收入 - 总支出) / 总收入</p>
</div>
</div>
</div>
</div>
</section>
<!-- Tab 4: Charts Analysis -->
<section class="tab-panel hidden" id="tab-charts">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
<!-- Asset Pie Chart -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4">资产构成</h3>
<div id="chart-assets" style="height: 300px;"></div>
</div>
<!-- Net Worth Trend Line Chart -->
<div class="bg-white rounded-lg shadow-md p-6">
<h3 class="text-lg font-bold text-gray-800 mb-4">净资产趋势 (近6个月)</h3>
<div id="chart-trend" style="height: 300px;"></div>
</div>
</div>
<!-- Summary Table -->
<div class="bg-white rounded-lg shadow-md p-6 overflow-x-auto">
<h3 class="text-lg font-bold text-gray-800 mb-4">所有月份统计数据汇总</h3>
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">月份</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">总资产</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">总负债</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">净资产</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">总收入</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">总支出</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">投资收入</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">ROE</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200" id="summary-table-body">
<!-- Rows will be injected by JS -->
</tbody>
</table>
</div>
</section>
</div>
</main>
<!-- Footer -->
<footer class="bg-gray-800 text-gray-400 text-center p-4 mt-auto">
<p>© 2026 个人财务报表软件 | 本地存储版本</p>
</footer>
<!-- Application Logic -->
<script>
        /**
         * Application State and Logic
         */
        const app = {
            data: {
                currentMonth: '2026-02',
                records: {} // Structure: { '2026-01': { cash: 0, ... }, '2026-02': { ... } }
            },
            
            // Default structure for a new month record
            defaultRecord: {
                cash: 0,
                bank: 0,
                equity: 0,
                realEstate: 0,
                creditCard: 0,
                bankLoan: 0,
                salary: 0,
                otherIncome: 0,
                newInvestment: 0
            },

            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.renderInputs();
                this.updateUI();
                this.showToast('欢迎使用个人财务报表软件', 'info');
            },

            loadFromStorage() {
                const stored = localStorage.getItem('financial_records');
                if (stored) {
                    try {
                        this.data.records = JSON.parse(stored);
                    } catch (e) {
                        console.error('Data parse error', e);
                        this.data.records = {};
                    }
                }
                // Ensure current month exists in records object, even if empty
                if (!this.data.records[this.data.currentMonth]) {
                    this.data.records[this.data.currentMonth] = { ...this.defaultRecord };
                }
            },

            saveToStorage() {
                localStorage.setItem('financial_records', JSON.stringify(this.data.records));
            },

            getRecord(month) {
                if (!this.data.records[month]) {
                    // Return a fresh copy if it doesn't exist
                    return { ...this.defaultRecord };
                }
                return this.data.records[month];
            },

            getPreviousMonth(monthStr) {
                const date = new Date(monthStr + '-01'); // Append day to make it valid
                date.setMonth(date.getMonth() - 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            },

            calculateMetrics(month) {
                const current = this.getRecord(month);
                const prevMonthStr = this.getPreviousMonth(month);
                const prev = this.getRecord(prevMonthStr);

                // --- Balance Sheet ---
                const totalAssets = parseFloat(current.cash) + parseFloat(current.bank) + parseFloat(current.equity) + parseFloat(current.realEstate);
                const totalLiabilities = parseFloat(current.creditCard) + parseFloat(current.bankLoan);
                const netWorth = totalAssets - totalLiabilities;

                const prevNetWorth = (parseFloat(prev.cash) + parseFloat(prev.bank) + parseFloat(prev.equity) + parseFloat(prev.realEstate)) - 
                                     (parseFloat(prev.creditCard) + parseFloat(prev.bankLoan));

                // --- Income Statement ---
                // Investment Income = Current Equity - Last Month Equity - New Investment
                const investmentIncome = parseFloat(current.equity) - parseFloat(prev.equity) - parseFloat(current.newInvestment);
                
                const totalIncome = parseFloat(current.salary) + parseFloat(current.otherIncome) + investmentIncome;

                // Total Expense = Last Month Net Worth + Current Total Income - Current Net Worth
                const totalExpense = prevNetWorth + totalIncome - netWorth;

                // --- Other Stats ---
                // ROE = (Salary * 12) / Net Worth
                let roe = 0;
                if (netWorth !== 0) {
                    roe = (parseFloat(current.salary) * 12) / netWorth;
                }

                // Savings Rate = (Income - Expense) / Income
                let savingsRate = 0;
                if (totalIncome !== 0) {
                    savingsRate = (totalIncome - totalExpense) / totalIncome;
                }

                return {
                    totalAssets,
                    totalLiabilities,
                    netWorth,
                    prevNetWorth,
                    investmentIncome,
                    totalIncome,
                    totalExpense,
                    roe,
                    savingsRate
                };
            },

            updateStateFromInputs() {
                const inputs = document.querySelectorAll('input[type="number"]');
                const currentRecord = this.data.records[this.data.currentMonth] || { ...this.defaultRecord };
                
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        currentRecord[name] = input.value === '' ? 0 : parseFloat(input.value);
                    }
                });

                this.data.records[this.data.currentMonth] = currentRecord;
                this.updateUI();
            },

            renderInputs() {
                const record = this.getRecord(this.data.currentMonth);
                const inputs = document.querySelectorAll('input[type="number"]');
                
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && record[name] !== undefined) {
                        input.value = record[name] === 0 ? '' : record[name];
                    }
                });
            },

            updateUI() {
                const metrics = this.calculateMetrics(this.data.currentMonth);
                const formatCurrency = (num) => {
                    return '¥' + num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };
                const formatPercent = (num) => {
                    return (num * 100).toFixed(2) + '%';
                };

                // Update Summary Cards
                document.getElementById('summary-net-worth').textContent = formatCurrency(metrics.netWorth);
                document.getElementById('summary-total-income').textContent = formatCurrency(metrics.totalIncome);
                document.getElementById('summary-total-expense').textContent = formatCurrency(metrics.totalExpense);

                // Update Balance Sheet
                document.getElementById('display-total-assets').textContent = formatCurrency(metrics.totalAssets);
                document.getElementById('display-total-liabilities').textContent = formatCurrency(metrics.totalLiabilities);
                document.getElementById('display-net-worth').textContent = formatCurrency(metrics.netWorth);

                // Update Income Statement
                document.getElementById('display-inv-income').textContent = formatCurrency(metrics.investmentIncome);
                document.getElementById('display-total-income').textContent = formatCurrency(metrics.totalIncome);
                document.getElementById('display-total-expense').textContent = formatCurrency(metrics.totalExpense);
                
                // Formula Details
                document.getElementById('calc-last-nw').textContent = formatCurrency(metrics.prevNetWorth);
                document.getElementById('calc-cur-income').textContent = formatCurrency(metrics.totalIncome);
                document.getElementById('calc-cur-nw').textContent = formatCurrency(metrics.netWorth);

                // Update Other Stats
                document.getElementById('stats-inv-income').textContent = formatCurrency(metrics.investmentIncome);
                document.getElementById('stats-roe').textContent = formatPercent(metrics.roe);
                document.getElementById('stats-savings-rate-text').textContent = formatPercent(metrics.savingsRate);
                
                // Savings Bar
                const savingsPercent = Math.max(0, Math.min(100, metrics.savingsRate * 100));
                const savingsBar = document.getElementById('stats-savings-bar');
                savingsBar.style.width = savingsPercent + '%';
                // Color change based on rate
                if(savingsPercent < 0) savingsBar.className = 'bg-red-500 h-2.5 rounded-full';
                else if(savingsPercent < 20) savingsBar.className = 'bg-yellow-500 h-2.5 rounded-full';
                else savingsBar.className = 'bg-green-500 h-2.5 rounded-full';

                // Update Charts
                this.updateCharts();
                this.updateTable();
            },

            updateCharts() {
                // Asset Pie Chart
                const record = this.getRecord(this.data.currentMonth);
                const pieChartDom = document.getElementById('chart-assets');
                if (pieChartDom) {
                    const myPieChart = echarts.init(pieChartDom);
                    const pieOption = {
                        tooltip: { trigger: 'item', formatter: '{b}: ¥{c} ({d}%)' },
                        legend: { bottom: '0%' },
                        series: [
                            {
                                name: '资产构成',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                                label: { show: false, position: 'center' },
                                emphasis: { label: { show: true, fontSize: 16, fontWeight: 'bold' } },
                                data: [
                                    { value: record.cash, name: '现金' },
                                    { value: record.bank, name: '银行存款' },
                                    { value: record.equity, name: '股权投资' },
                                    { value: record.realEstate, name: '房地产' }
                                ]
                            }
                        ]
                    };
                    myPieChart.setOption(pieOption);
                }

                // Net Worth Trend Chart (Last 6 months)
                const trendChartDom = document.getElementById('chart-trend');
                if (trendChartDom) {
                    const myTrendChart = echarts.init(trendChartDom);
                    
                    // Get last 6 months keys
                    const months = Object.keys(this.data.records).sort().slice(-6);
                    const data = months.map(m => this.calculateMetrics(m).netWorth);

                    const trendOption = {
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', boundaryGap: false, data: months },
                        yAxis: { type: 'value' },
                        series: [
                            {
                                name: '净资产',
                                type: 'line',
                                stack: 'Total',
                                areaStyle: { opacity: 0.3 },
                                emphasis: { focus: 'series' },
                                data: data,
                                itemStyle: { color: '#4F46E5' },
                                lineStyle: { width: 3 }
                            }
                        ]
                    };
                    myTrendChart.setOption(trendOption);
                }
            },

            updateTable() {
                const tbody = document.getElementById('summary-table-body');
                tbody.innerHTML = '';
                
                const months = Object.keys(this.data.records).sort();
                const formatCurrency = (num) => '¥' + num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const formatPercent = (num) => (num * 100).toFixed(2) + '%';

                months.forEach(m => {
                    const metrics = this.calculateMetrics(m);
                    const row = document.createElement('tr');
                    row.className = m === this.data.currentMonth ? 'bg-indigo-50' : 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatCurrency(metrics.totalAssets)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatCurrency(metrics.totalLiabilities)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900 font-bold">${formatCurrency(metrics.netWorth)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600">${formatCurrency(metrics.totalIncome)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${formatCurrency(metrics.totalExpense)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatCurrency(metrics.investmentIncome)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatPercent(metrics.roe)}</td>
                    `;
                    tbody.appendChild(row);
                });
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                let icon = '';
                if (type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-500 mr-3 text-lg"></i>';
                else if (type === 'error') icon = '<i class="fa-solid fa-circle-exclamation text-red-500 mr-3 text-lg"></i>';
                else icon = '<i class="fa-solid fa-circle-info text-blue-500 mr-3 text-lg"></i>';

                toast.innerHTML = `${icon}<span class="text-sm font-medium text-gray-800">${message}</span>`;
                
                container.appendChild(toast);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    toast.style.transition = 'all 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            setupEventListeners() {
                // Month Picker
                const monthPicker = document.getElementById('month-picker');
                monthPicker.value = this.data.currentMonth;
                monthPicker.addEventListener('change', (e) => {
                    this.data.currentMonth = e.target.value;
                    // Initialize record if new
                    if (!this.data.records[this.data.currentMonth]) {
                        this.data.records[this.data.currentMonth] = { ...this.defaultRecord };
                    }
                    this.renderInputs();
                    this.updateUI();
                    this.showToast(`已切换至 ${this.data.currentMonth}`, 'info');
                });

                // Inputs - Real-time calculation
                const inputs = document.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.updateStateFromInputs());
                });

                // Tab Switching
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabPanels = document.querySelectorAll('.tab-panel');

                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active classes
                        tabBtns.forEach(b => {
                            b.classList.remove('active', 'text-indigo-600', 'border-indigo-600');
                            b.classList.add('text-gray-500', 'border-transparent');
                        });
                        tabPanels.forEach(p => p.classList.add('hidden'));

                        // Add active class
                        btn.classList.add('active', 'text-indigo-600', 'border-indigo-600');
                        btn.classList.remove('text-gray-500', 'border-transparent');
                        
                        const targetId = btn.getAttribute('data-target');
                        document.getElementById(targetId).classList.remove('hidden');

                        // Resize charts if chart tab is opened
                        if (targetId === 'tab-charts') {
                            setTimeout(() => {
                                echarts.getInstanceByDom(document.getElementById('chart-assets'))?.resize();
                                echarts.getInstanceByDom(document.getElementById('chart-trend'))?.resize();
                            }, 100);
                        }
                    });
                });

                // Save Button
                document.getElementById('btn-save').addEventListener('click', () => {
                    this.saveToStorage();
                    this.showToast('数据保存成功');
                });

                // Reset Button
                document.getElementById('btn-reset').addEventListener('click', () => {
                    if(confirm('确定要重置当前月份的所有数据吗？此操作无法撤销。')) {
                        this.data.records[this.data.currentMonth] = { ...this.defaultRecord };
                        this.renderInputs();
                        this.updateUI();
                        this.saveToStorage();
                        this.showToast('当前月份数据已重置', 'info');
                    }
                });

                // Export Button
                document.getElementById('btn-export').addEventListener('click', () => {
                    const dataStr = JSON.stringify(this.data.records, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `financial_data_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showToast('数据导出已开始', 'info');
                });

                // Import Trigger
                document.getElementById('btn-import-trigger').addEventListener('click', () => {
                    document.getElementById('file-import').click();
                });

                // Import File Handler
                document.getElementById('file-import').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (typeof importedData === 'object') {
                                // Merge logic: keep existing, overwrite/add imported
                                this.data.records = { ...this.data.records, ...importedData };
                                this.saveToStorage();
                                this.renderInputs();
                                this.updateUI();
                                this.showToast('数据导入成功');
                            } else {
                                throw new Error('Invalid format');
                            }
                        } catch (err) {
                            this.showToast('导入失败：文件格式错误', 'error');
                        }
                        e.target.value = ''; // Reset input
                    };
                    reader.readAsText(file);
                });

                // Window Resize for Charts
                window.addEventListener('resize', () => {
                    echarts.getInstanceByDom(document.getElementById('chart-assets'))?.resize();
                    echarts.getInstanceByDom(document.getElementById('chart-trend'))?.resize();
                });
            }
        };

        // Initialize App when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>